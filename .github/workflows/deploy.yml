# name: Deploy to Droplet

# on:
#   push:
#     branches:
#       - main
# jobs:
#   deploy-bot:
#     runs-on: ubuntu-latest

#     permissions:
#       contents: read
#       packages: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Log in to GitHub Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ghcr.io
#           username: ${{ github.actor }}
#           password: ${{ secrets.TOKEN }}

#       - name: Build and push Bot Docker image to GHCR
#         uses: docker/build-push-action@v6
#         with:
#           context: ./bot
#           file: ./bot/Dockerfile
#           push: true
#           tags: |
#             ghcr.io/${{ github.repository_owner }}/open-rabbit-bot:latest
#             ghcr.io/${{ github.repository_owner }}/open-rabbit-bot:${{ github.sha }}

#       - name: SSH into Droplet and deploy bot container
#         uses: appleboy/ssh-action@v1.2.0
#         with:
#           host: ${{ secrets.DROPLET_IP }}
#           username: ${{ secrets.DROPLET_USER }}
#           key: ${{ secrets.DROPLET_SSH_KEY }}
#           script: |
#             echo "Logging in to GHCR..."
#             echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

#             echo "Pulling latest bot image..."
#             docker pull ghcr.io/${{ github.repository_owner }}/open-rabbit-bot:latest

#             echo "Stopping old bot container..."
#             docker stop open-rabbit-bot || true
#             docker rm open-rabbit-bot || true

#             echo "Starting new bot container..."
#             docker run -d \
#               --name open-rabbit-bot \
#               --restart unless-stopped \
#               -p 3000:3000 \
#               -e APP_ID="${{ secrets.GITHUB_APP_ID }}" \
#               -e PRIVATE_KEY="${{ secrets.GITHUB_APP_PRIVATE_KEY }}" \
#               -e WEBHOOK_SECRET="${{ secrets.GITHUB_WEBHOOK_SECRET }}" \
#               -e WEBHOOK_PROXY_URL="${{ secrets.WEBHOOK_PROXY_URL }}" \
#               -e BACKEND_URL="${{ secrets.BACKEND_URL }}" \
#               ghcr.io/${{ github.repository_owner }}/open-rabbit-bot:latest

#             echo "Cleaning up old images..."
#             docker image prune -f

#             echo "Bot deployment complete!"

