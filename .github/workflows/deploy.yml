# name: Deploy to Droplet

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'bot/**'
#       - 'backend/**'
#       - 'docker-compose.yml'
#       - '.github/workflows/deploy.yml'

# jobs:
#   build-and-push:
#     runs-on: ubuntu-latest

#     permissions:
#       contents: read
#       packages: write

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Log in to GitHub Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ghcr.io
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}

#       - name: Build and push Bot Docker image
#         uses: docker/build-push-action@v6
#         with:
#           context: ./bot
#           file: ./bot/Dockerfile
#           push: true
#           tags: |
#             ghcr.io/${{ github.repository_owner }}/open-rabbit-bot:latest
#             ghcr.io/${{ github.repository_owner }}/open-rabbit-bot:${{ github.sha }}

#   deploy:
#     needs: build-and-push
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Copy docker-compose.yml to Droplet
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.DROPLET_IP }}
#           username: ${{ secrets.DROPLET_USER }}
#           key: ${{ secrets.DROPLET_SSH_KEY }}
#           source: "docker-compose.yml"
#           target: "~/open-rabbit/"

#       - name: Deploy with Docker Compose
#         uses: appleboy/ssh-action@v1.2.0
#         with:
#           host: ${{ secrets.DROPLET_IP }}
#           username: ${{ secrets.DROPLET_USER }}
#           key: ${{ secrets.DROPLET_SSH_KEY }}
#           script: |
#             cd ~/open-rabbit

#             echo "Creating .env file..."
#             cat > .env << EOF
#             GITHUB_APP_ID=${{ secrets.GITHUB_APP_ID }}
#             GITHUB_APP_PRIVATE_KEY=${{ secrets.GITHUB_APP_PRIVATE_KEY }}
#             GITHUB_WEBHOOK_SECRET=${{ secrets.GITHUB_WEBHOOK_SECRET }}
#             WEBHOOK_PROXY_URL=${{ secrets.WEBHOOK_PROXY_URL }}
#             BACKEND_URL=${{ secrets.BACKEND_URL }}
#             EOF

#             echo "Logging in to GHCR..."
#             echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

#             echo "Pulling latest images..."
#             docker compose pull

#             echo "Stopping old containers..."
#             docker compose down

#             echo "Starting containers with Docker Compose..."
#             docker compose up -d

#             echo "Cleaning up old images..."
#             docker image prune -f

#             echo "Deployment complete!"
#             echo "Running containers:"
#             docker compose ps

